# 勤怠チェック＋是正理由作成システム 要件定義書

## 1. プロジェクト概要

### 1.1 目的
勤怠データに潜む異常（打刻漏れ・休憩不足・超過など）を自動検知し、管理者の以下の作業を効率化する：
- 確認
- 是正（修正・連絡）
- 説明文（是正理由）作成
- 記録保存（監査・労基・社内向け）

### 1.2 ターゲット業界
**飲食業界特化**
- シフト制・深夜帯勤務が多い
- アルバイト比率が高く打刻漏れ頻発
- 店長のワンオペ締め作業負担が大きい

### 1.3 提供価値
- 勤怠の異常箇所の見落としを減らす
- 是正理由を毎回ゼロから書かなくていい
- 説明の履歴（証跡）が残る

### 1.4 成功指標

| 種別 | 指標 |
|------|------|
| 定量 | 月次200名×31日のCSV処理を30秒以内 |
| 定量 | 是正理由作成時間を従来比50%以上短縮 |
| 定量 | 異常検知漏れゼロ（設定ルール範囲内） |
| 定性 | 毎月の勤怠締め作業が苦痛でなくなる |
| 定性 | 監査・労基対応で説明に困らない |
| 定性 | 異常箇所だけ見ればいい安心感 |

### 1.5 重要な前提（免責）
- 本システムは法令判定を代替しない
- 最終判断は利用者が行う
- 検知と文面たたき台の提供が役割

---

## 2. システム全体像

### 2.1 機能ブロック
1. **取り込み** - CSV/Excelアップロード
2. **検知** - ルールエンジンによる異常検知
3. **レビュー** - 画面で確認
4. **是正** - 連絡・修正・承認
5. **理由文生成** - テンプレ＋スロット方式
6. **履歴・出力** - PDF/CSV出力、共有リンク

### 2.2 ユーザーロール

| ロール | 説明 | 想定ユーザー |
|--------|------|-------------|
| 管理者 | 全店舗の閲覧・操作・設定変更 | 本部労務担当、オーナー |
| 店舗管理者 | 自店舗のみ閲覧・操作 | 店長、エリアマネージャー |
| 閲覧者 | 閲覧のみ（編集不可） | 監査対応、社労士 |

### 2.3 認証要件

| 項目 | 仕様 |
|------|------|
| 認証方式 | メール＋パスワード |
| 登録方式 | 招待制（管理者が招待リンク発行） |
| セッション | JWT + リフレッシュトークン |
| パスワード | 8文字以上、ブルートフォース対策あり |

---

## 3. ページ詳細仕様

### P-001: ログイン
- **ルート**: `/login`
- **権限**: 全員
- **目的**: ユーザー認証
- **機能**:
  - メール・パスワード入力
  - ログインボタン
  - パスワードリセットリンク
  - エラー表示（認証失敗時）

### P-002: 取り込み＆異常一覧（メイン画面）
- **ルート**: `/dashboard`
- **権限**: 店舗管理者以上
- **目的**: CSV取り込み→即座に異常一覧表示
- **機能**:
  - CSVドラッグ＆ドロップエリア
  - フォーマット自動判別（ジョブカン/Airシフト/汎用）
  - プレビュー表示（取り込み前確認）
  - 異常一覧テーブル
    - フィルタ: 店舗/従業員/種別/重要度/ステータス
    - ソート: 日付/重要度/ステータス
  - 異常種別バッジ（打刻漏れ/休憩不足/長時間/深夜/不整合）
  - ステータス表示（未対応/対応中/完了）
  - 一括操作（複数選択→ステータス変更）

### P-003: 異常詳細＆是正対応
- **ルート**: `/issues/:id`
- **権限**: 店舗管理者以上
- **目的**: 根拠表示・対応ログ・理由文生成を1画面で完結
- **機能**:
  - **根拠セクション**
    - 該当日の生データ表示
    - どのルールに引っかかったか表示
    - 関連データハイライト
  - **対応ログセクション**
    - ステータス変更（未対応→対応中→完了）
    - 対応メモ入力
    - 対応履歴一覧（誰が・いつ・何をした）
  - **理由文生成セクション**
    - 原因カテゴリ選択（打刻忘れ/端末不具合/業務都合/申請漏れ/その他）
    - 詳細メモ入力（任意）
    - 対応選択（修正依頼/本人確認/残業申請/注意喚起/周知）
    - 再発防止選択（運用周知/端末配置/チェックリスト/ダブルチェック）
    - 出力種別選択（社内記録用/本人確認用/監査向け）
    - 生成ボタン→プレビュー→コピー/保存

### P-004: レポート出力
- **ルート**: `/reports`
- **権限**: 店舗管理者以上
- **目的**: 月次レポートPDF/CSV生成・ダウンロード
- **機能**:
  - 期間選択（月単位）
  - 店舗選択（管理者は全店舗、店舗管理者は自店舗）
  - 出力形式選択（PDF/CSV）
  - レポート内容
    - 異常件数サマリー
    - 種別別内訳
    - 対応状況（完了/未完了）
    - 個票一覧
  - 個人情報マスク版出力（監査提出用）
  - ダウンロード/共有リンク発行

### P-005: 設定
- **ルート**: `/settings`
- **権限**: 管理者（一部店舗管理者）
- **目的**: ルール閾値・テンプレ・語彙辞書の管理
- **機能**:
  - **検知ルール設定**
    - 休憩ルール（6時間超→45分、8時間超→60分）
    - 日次上限アラート（10h/12h/カスタム）
    - 深夜帯定義（22:00〜05:00）
  - **理由文テンプレ管理**
    - 3種類（社内記録用/本人確認用/監査向け）
    - スロット定義（原因/対応/再発防止/日付/担当者）
  - **語彙辞書**
    - 置換ルール（従業員→スタッフ、等）
  - **店舗別設定**（管理者のみ）

### A-001: ユーザー管理
- **ルート**: `/admin/users`
- **権限**: 管理者のみ
- **目的**: ユーザーの招待・権限変更・削除
- **機能**:
  - ユーザー一覧
  - 招待リンク発行
  - ロール変更
  - 所属店舗変更
  - アカウント無効化/削除

### A-002: 店舗管理
- **ルート**: `/admin/stores`
- **権限**: 管理者のみ
- **目的**: 店舗の追加・編集
- **機能**:
  - 店舗一覧
  - 店舗追加/編集/削除
  - 店舗コード・名称管理

---

## 4. データ設計概要

### 4.1 主要エンティティ

```
Organization（組織）
├── Store（店舗）
├── User（ユーザー）
├── Employee（従業員マスタ）
├── AttendanceRecord（勤怠レコード）
├── Issue（異常）
│   ├── IssueLog（対応ログ）
│   └── CorrectionReason（是正理由文）
├── DetectionRule（検知ルール）
└── ReasonTemplate（理由文テンプレ）
```

### 4.2 主要テーブル

#### organizations
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| name | VARCHAR(100) | 組織名 |
| created_at | TIMESTAMP | 作成日時 |

#### stores
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| organization_id | UUID | FK |
| code | VARCHAR(20) | 店舗コード |
| name | VARCHAR(100) | 店舗名 |

#### users
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| organization_id | UUID | FK |
| store_id | UUID | FK（nullable、管理者はnull） |
| email | VARCHAR(255) | メールアドレス |
| password_hash | VARCHAR(255) | パスワードハッシュ |
| role | ENUM | admin/store_manager/viewer |
| is_active | BOOLEAN | 有効フラグ |

#### employees
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| organization_id | UUID | FK |
| store_id | UUID | FK |
| employee_code | VARCHAR(50) | 従業員コード |
| name | VARCHAR(100) | 氏名 |

#### attendance_records
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| employee_id | UUID | FK |
| date | DATE | 勤務日 |
| clock_in | TIME | 出勤時刻（nullable） |
| clock_out | TIME | 退勤時刻（nullable） |
| break_minutes | INTEGER | 休憩時間（分） |
| work_type | VARCHAR(20) | 勤務区分 |
| imported_at | TIMESTAMP | 取り込み日時 |

#### issues
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| attendance_record_id | UUID | FK |
| type | ENUM | missing_clock/insufficient_break/overtime/night_work/inconsistency |
| severity | ENUM | high/medium/low |
| status | ENUM | pending/in_progress/completed |
| detected_at | TIMESTAMP | 検知日時 |
| rule_description | TEXT | 適用ルールの説明 |

#### issue_logs
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| issue_id | UUID | FK |
| user_id | UUID | FK |
| action | VARCHAR(50) | アクション種別 |
| memo | TEXT | メモ |
| created_at | TIMESTAMP | 作成日時 |

#### correction_reasons
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| issue_id | UUID | FK |
| template_type | ENUM | internal/employee/audit |
| cause_category | VARCHAR(50) | 原因カテゴリ |
| cause_detail | TEXT | 原因詳細 |
| action_taken | VARCHAR(50) | 対応 |
| prevention | VARCHAR(50) | 再発防止 |
| generated_text | TEXT | 生成された理由文 |
| created_by | UUID | FK |
| created_at | TIMESTAMP | 作成日時 |

---

## 5. 異常検知ルール

### 5.1 MVP必須ルール

| ルールID | 種別 | 条件 | 重要度 |
|----------|------|------|--------|
| R001 | 打刻漏れ | 出勤のみ（退勤なし） | 高 |
| R002 | 打刻漏れ | 退勤のみ（出勤なし） | 高 |
| R003 | 休憩不足 | 6時間超勤務で休憩45分未満 | 高 |
| R004 | 休憩不足 | 8時間超勤務で休憩60分未満 | 高 |
| R005 | 長時間労働 | 日次勤務時間が閾値超過（デフォルト10h） | 中 |
| R006 | 深夜勤務 | 22:00〜05:00の勤務を含む | 低 |
| R007 | 不整合 | 退勤時刻 < 出勤時刻 | 高 |
| R008 | 不整合 | 休憩時間 > 勤務時間 | 高 |

### 5.2 ルールカスタマイズ

各ルールの閾値は設定画面で変更可能とする。

---

## 6. 是正理由文生成

### 6.1 出力種別

| 種別 | 用途 | トーン |
|------|------|--------|
| 社内記録用 | 社内の記録保存 | 簡潔、事実ベース |
| 本人確認用 | 従業員への確認・申請 | 丁寧、依頼調 |
| 監査向け | 労基・監査提出 | 客観的、個人情報最小 |

### 6.2 テンプレ構造

```
【事実】
{date}に{employee_name}の勤怠データにおいて、{issue_type}が検出されました。

【原因】
{cause_category}: {cause_detail}

【対応】
{action_taken}を実施しました。

【再発防止】
{prevention}を行います。

【対応者】
{handler_name} ({handled_at})
```

### 6.3 AI利用方針

- LLMは「文章の整形」「トーン調整」「自然な日本語化」に限定
- 事実・原因・対応・再発防止の内容はユーザー入力ベース
- テンプレ＋スロット方式で品質を安定化

---

## 7. セキュリティ要件

### 7.1 全システム必須

| 項目 | 仕様 |
|------|------|
| ヘルスチェック | `/api/health` |
| グレースフルシャットダウン | SIGTERM対応、8秒タイムアウト |
| HTTPS | 本番環境で強制 |
| 入力値サニタイゼーション | 全入力に適用 |

### 7.2 認証・認可

| 項目 | 仕様 |
|------|------|
| ブルートフォース対策 | 5回失敗で15分ロック |
| パスワードポリシー | 8文字以上 |
| セッション管理 | JWT（有効期限1時間）+ リフレッシュトークン（7日） |
| CSRF対策 | SameSite Cookie |

### 7.3 データ保護

| 項目 | 仕様 |
|------|------|
| 通信暗号化 | TLS 1.3 |
| 保管時暗号化 | AES-256（DB側） |
| 監査ログ | 全操作を記録（誰が・いつ・何を） |
| データ削除 | 退会時に全データ削除（30日猶予） |

---

## 8. 技術スタック

### 8.1 フロントエンド

| 項目 | 選定 |
|------|------|
| フレームワーク | React 18 |
| 言語 | TypeScript 5 |
| UIライブラリ | MUI v6 |
| ビルド | Vite 5 |
| ルーティング | React Router v6 |
| 状態管理 | Zustand |
| データフェッチ | React Query (TanStack Query) |

### 8.2 バックエンド

| 項目 | 選定 |
|------|------|
| フレームワーク | FastAPI |
| 言語 | Python 3.12 |
| ORM | SQLAlchemy 2.0 |
| バリデーション | Pydantic v2 |
| 認証 | python-jose (JWT) |

### 8.3 インフラ

| 項目 | 選定 |
|------|------|
| フロントエンドホスティング | Vercel |
| バックエンドホスティング | Google Cloud Run |
| データベース | Neon (PostgreSQL) |
| ファイルストレージ | Cloud Storage（PDF出力用） |

---

## 9. 外部サービス一覧

| サービス | 用途 | 料金 |
|----------|------|------|
| OpenAI GPT-4o-mini | 是正理由文の整形 | 従量課金（$0.15/1M入力トークン） |
| Neon PostgreSQL | データベース | 無料枠0.5GB |
| Google Cloud Run | バックエンドAPI | 従量課金 |
| Vercel | フロントエンドホスティング | 無料枠 |
| Cloud Storage | PDF保存 | 従量課金 |

---

## 10. 対応勤怠SaaSフォーマット

### 10.1 MVP対応

| SaaS | フォーマット | 備考 |
|------|-------------|------|
| ジョブカン | CSV | 飲食業界で普及 |
| Airシフト | CSV | リクルート系、飲食に強い |
| 汎用 | CSV | カラムマッピング機能で対応 |

### 10.2 必須カラム（正規化後）

- employee_id または employee_code + name
- date
- clock_in
- clock_out
- break_minutes
- store_code（任意）
- work_type（任意）

---

## 11. 非機能要件

| 項目 | 要件 |
|------|------|
| 処理性能 | 月次200名×31日（6,200件）を30秒以内 |
| 可用性 | 99.5%（月間ダウンタイム3.6時間以内） |
| 同時接続 | 50ユーザー |
| データ保持 | 3年間 |
| バックアップ | 日次自動バックアップ |

---

## 12. 価格設計（参考）

| プラン | 店舗数 | 管理者数 | 月額 |
|--------|--------|---------|------|
| スターター | 1店舗 | 2名 | ¥5,000 |
| スタンダード | 5店舗 | 10名 | ¥15,000 |
| エンタープライズ | 無制限 | 無制限 | 要相談 |

---

## 13. リスクと対策

| リスク | 対策 |
|--------|------|
| 法令責任に見られる | 「本システムは判断を代替しない」表記を徹底 |
| 誤検知・漏れ | 根拠表示＋例外登録＋ルール設定を柔軟に |
| 個人情報漏洩 | マスク出力、アクセスログ、暗号化 |
| 現場運用が面倒 | 最短導線設計（CSV→取り込み→赤だけ確認→文章出力） |

---

*最終更新: 2026-02-03*
*Phase 1: 要件定義 完了*
